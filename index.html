<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Arlo - Year 8 Timetable (Grid)</title>
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #020617;
      color: #e5e7eb;
    }

    body {
      margin: 0;
      display: flex;
      justify-content: center;
      padding: 24px;
    }

    .app {
      width: 100%;
      max-width: 1100px;
      background: #020617;
      border-radius: 18px;
      box-shadow: 0 24px 80px rgba(0,0,0,0.65);
      padding: 20px 24px 26px;
      box-sizing: border-box;
      border: 1px solid #1f2937;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 14px;
      gap: 8px;
      flex-wrap: wrap;
    }

    header h1 {
      font-size: 1.4rem;
      margin: 0;
    }

    header span {
      font-size: 0.9rem;
      color: #9ca3af;
    }

    #jsStatus {
      font-size: 0.8rem;
      color: #f97316;
    }

    #jsStatus.ready {
      color: #22c55e;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 12px;
    }

    thead {
      background: #111827;
    }

    th, td {
      padding: 8px 10px;
      text-align: left;
      font-size: 0.9rem;
      border-bottom: 1px solid #1f2937;
      vertical-align: top;
    }

    th {
      font-weight: 600;
      color: #d1d5db;
      text-align: center;
    }

    th:first-child {
      text-align: left;
      width: 170px;
    }

    tbody tr:nth-child(odd) {
      background: #030712;
    }

    tbody tr:nth-child(even) {
      background: #020617;
    }

    tr.special-row {
      background: #020617;
    }

    td.period-col {
      background: #020617;
      position: sticky;
      left: 0;
      z-index: 1;
    }

    .period-name {
      font-weight: 600;
    }

    .period-time {
      font-size: 0.8rem;
      color: #9ca3af;
      margin-top: 2px;
      font-variant-numeric: tabular-nums;
    }

    td.cell-empty,
    td.cell-special,
    td.cell-lesson {
      cursor: pointer;
      position: relative;
      transition: background 0.08s, transform 0.05s, box-shadow 0.08s;
    }

    td.cell-empty:hover,
    td.cell-special:hover,
    td.cell-lesson:hover {
      background: #111827;
      transform: translateY(-1px);
      box-shadow: 0 8px 18px rgba(0,0,0,0.45);
      z-index: 2;
    }

    td.cell-empty {
      text-align: center;
      color: #4b5563;
      font-style: italic;
    }

    td.cell-special {
      text-align: center;
      color: #9ca3af;
      font-style: italic;
    }

    td.cell-lesson {
      padding: 7px 8px;
    }

    .subject-row {
      display: flex;
      justify-content: space-between;
      gap: 4px;
      align-items: baseline;
    }

    .subject-name {
      font-weight: 600;
      font-size: 0.9rem;
    }

    .room-tag {
      font-size: 0.75rem;
      color: #9ca3af;
      padding: 1px 6px;
      border-radius: 999px;
      border: 1px solid #374151;
      white-space: nowrap;
    }

    .cell-flags {
      display: flex;
      gap: 4px;
      margin-top: 4px;
      flex-wrap: wrap;
      min-height: 1.1em;
    }

    .flag {
      font-size: 0.7rem;
      padding: 1px 6px;
      border-radius: 999px;
      border: 1px solid #4b5563;
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }

    .fav-flag {
      border-color: #facc15;
      color: #facc15;
    }

    .catchup-flag {
      border-color: #ef4444;
      color: #ef4444;
    }

    .notes-hint {
      margin-top: 4px;
      font-size: 0.7rem;
      color: #22c55e;
    }

    .catchup-target-hint {
      margin-top: 3px;
      font-size: 0.72rem;
      color: #38bdf8;
    }

    .footer-note {
      margin-top: 4px;
      font-size: 0.8rem;
      color: #6b7280;
    }

    /* Popup overlay */
    .overlay {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }

    .overlay.visible {
      display: flex;
    }

    .overlay-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(0,0,0,0.6);
    }

    .lesson-popup {
      position: relative;
      background: #020617;
      border-radius: 16px;
      padding: 16px 18px 14px;
      width: 100%;
      max-width: 430px;
      box-shadow: 0 24px 80px rgba(0,0,0,0.8);
      border: 1px solid #1f2937;
      z-index: 1;
    }

    .lesson-popup h2 {
      margin: 0 0 6px;
      font-size: 1rem;
    }

    .lesson-popup h3 {
      margin: 10px 0 4px;
      font-size: 0.9rem;
      color: #e5e7eb;
    }

    .popup-meta {
      font-size: 0.8rem;
      color: #9ca3af;
      margin-bottom: 8px;
    }

    .popup-meta div + div {
      margin-top: 2px;
    }

    .checkbox-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin: 6px 0;
      font-size: 0.85rem;
    }

    .checkbox-row input[type="checkbox"] {
      width: 16px;
      height: 16px;
      accent-color: #22c55e;
      cursor: pointer;
    }

    .notes-label {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-top: 6px;
      font-size: 0.85rem;
    }

    textarea {
      border-radius: 8px;
      border: 1px solid #374151;
      padding: 6px 8px;
      background: #020617;
      color: #e5e7eb;
      resize: vertical;
      min-height: 80px;
      font-family: inherit;
      font-size: 0.85rem;
    }

    .popup-actions {
      margin-top: 10px;
      display: flex;
      justify-content: flex-end;
      gap: 6px;
    }

    .popup-actions button {
      border-radius: 999px;
      padding: 6px 14px;
      border: none;
      cursor: pointer;
      font-size: 0.85rem;
    }

    #popupSave {
      background: #22c55e;
      color: #022c22;
      font-weight: 600;
    }

    #popupCancel {
      background: #111827;
      color: #e5e7eb;
      border: 1px solid #374151;
    }

    .close-btn {
      position: absolute;
      top: 6px;
      right: 8px;
      border: none;
      background: transparent;
      color: #9ca3af;
      cursor: pointer;
      font-size: 1.1rem;
      padding: 0;
      line-height: 1;
    }

    .close-btn:hover {
      color: #e5e7eb;
    }

    .catchup-list {
      margin: 4px 0 6px;
      font-size: 0.8rem;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .catchup-item {
      display: flex;
      justify-content: space-between;
      gap: 6px;
      align-items: center;
    }

    .catchup-remove-btn {
      border-radius: 999px;
      border: 1px solid #4b5563;
      background: #020617;
      color: #e5e7eb;
      font-size: 0.75rem;
      padding: 2px 8px;
      cursor: pointer;
    }

    .catchup-add-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
      margin-top: 4px;
      font-size: 0.8rem;
    }

    .catchup-add-row label {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .catchup-add-row select {
      background: #020617;
      color: #e5e7eb;
      border: 1px solid #374151;
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 0.8rem;
    }

    .catchup-add-row button {
      border-radius: 999px;
      border: 1px solid #374151;
      background: #111827;
      color: #e5e7eb;
      padding: 3px 10px;
      font-size: 0.8rem;
      cursor: pointer;
    }

    .catchup-hint {
      margin-top: 3px;
      font-size: 0.75rem;
      color: #6b7280;
    }

    .catchup-empty {
      font-size: 0.8rem;
      color: #6b7280;
      font-style: italic;
    }

    @media (max-width: 768px) {
      body {
        padding: 10px;
      }
      .app {
        padding: 14px 10px 18px;
      }
      th, td {
        padding: 6px 4px;
        font-size: 0.8rem;
      }
      .room-tag {
        display: none;
      }
    }
  </style>
</head>
<body>
<div class="app">
  <header>
    <div>
      <h1>Arlo M · Year 8 Timetable</h1>
      <span>Click any slot to add notes, favourites and catch-up times.</span>
    </div>
    <span id="jsStatus">JS loading…</span>
  </header>

  <table>
    <thead>
      <tr>
        <th>Period / Time</th>
        <th>Monday</th>
        <th>Tuesday</th>
        <th>Wednesday</th>
        <th>Thursday</th>
        <th>Friday</th>
      </tr>
    </thead>
    <tbody id="gridBody"></tbody>
  </table>

  <div class="footer-note">
    All notes are stored in this browser using local storage.
    Use the same device for everything to stick.
  </div>
</div>

<!-- Popup overlay -->
<div id="lessonOverlay" class="overlay">
  <div class="overlay-backdrop"></div>
  <div class="lesson-popup">
    <button class="close-btn" id="popupClose" aria-label="Close">&times;</button>
    <h2 id="popupTitle">Details</h2>
    <div class="popup-meta">
      <div id="popupSubject"></div>
      <div id="popupWhen"></div>
      <div id="popupRoom"></div>
    </div>

    <div id="popupFavRow" class="checkbox-row">
      <input type="checkbox" id="popupFavouriteSubject">
      <span>Mark this subject as a favourite</span>
    </div>

    <div id="popupNeedsRow" class="checkbox-row">
      <input type="checkbox" id="popupNeedsCatchup">
      <span>This lesson needs catching up</span>
    </div>

    <label class="notes-label">
      <span>Notes for this time</span>
      <textarea id="popupNotes"
        placeholder="What was this lesson or catch-up about? Homework, tests, anything to remember..."></textarea>
    </label>

    <div id="popupCatchupSection">
      <h3>Catch-up times for this lesson</h3>
      <div id="catchupList" class="catchup-list"></div>
      <div class="catchup-add-row">
        <label>
          Day
          <select id="catchupDaySelect"></select>
        </label>
        <label>
          Time
          <select id="catchupPeriodSelect"></select>
        </label>
        <button type="button" id="catchupAddBtn">Add</button>
      </div>
      <div class="catchup-hint">
        Choose when the catch-up will happen. You can use break, lunch or another lesson.
      </div>
    </div>

    <div id="popupScheduledForSection">
      <h3>Catch-ups scheduled in this time</h3>
      <div id="scheduledForList" class="catchup-list"></div>
    </div>

    <div class="popup-actions">
      <button id="popupCancel" class="secondary">Cancel</button>
      <button id="popupSave">Save</button>
    </div>
  </div>
</div>

<script>
  // ---------- Data ---------------------------------------------------------
  const timetable = {
    periods: [
      { key: "reg",   name: "Registration", start: "08:45", end: "09:05" },
      { key: "l1",    name: "Lesson 1",     start: "09:05", end: "09:55" },
      { key: "l2",    name: "Lesson 2",     start: "09:55", end: "10:45" },
      { key: "break", name: "Break",        start: "10:45", end: "11:05", special: true },
      { key: "l3",    name: "Lesson 3",     start: "11:05", end: "11:55" },
      { key: "l4",    name: "Lesson 4",     start: "11:55", end: "12:45" },
      { key: "lunch", name: "Lunch",        start: "12:45", end: "13:35", special: true },
      { key: "l5",    name: "Lesson 5",     start: "13:35", end: "14:25" },
      { key: "l6",    name: "Lesson 6",     start: "14:25", end: "15:15" },
      { key: "tutor", name: "Tutor Time",   start: "15:15", end: "15:20", special: true }
    ],
    days: {
      "Monday": {
        reg:   { subject: "Registration", room: null },
        l1:    { subject: "Art",   room: "PHA 901" },
        l2:    { subject: "Eng",   room: "JGR 304" },
        break: null,
        l3:    { subject: "Sci",   room: "KTU 308" },
        l4:    { subject: "Maths", room: "VWA 303" },
        lunch: null,
        l5:    { subject: "Music", room: "Chapel" },
        l6:    { subject: "DT",    room: "ADB 704" },
        tutor: null
      },
      "Tuesday": {
        reg:   { subject: "Registration", room: null },
        l1:    { subject: "Eng",       room: "JGR 304" },
        l2:    { subject: "Computing", room: "APR 904" },
        break: null,
        l3:    { subject: "H. Cook",   room: "AJO 601" },
        l4:    { subject: "PE",        room: "COT 505" },
        lunch: null,
        l5:    { subject: "Maths",     room: "VWA 303" },
        l6:    { subject: "P. Arts",   room: "RDO 1608" },
        tutor: null
      },
      "Wednesday": {
        reg:   { subject: "Registration", room: null },
        l1:    { subject: "Hums",  room: "MCO 407" },
        l2:    { subject: "Com",   room: "RPA 307" },
        break: null,
        l3:    { subject: "Eng",   room: "JGR 304" },
        l4:    { subject: "Maths", room: "VWA 303" },
        lunch: null,
        l5:    { subject: "Hums",  room: "MCO 407" },
        l6:    { subject: "Sci",   room: "KTU 308" },
        tutor: null
      },
      "Thursday": {
        reg:   { subject: "Registration", room: null },
        l1:    { subject: "DT",   room: "ADB 704" },
        l2:    { subject: "Eng",  room: "JGR 304" },
        break: null,
        l3:    { subject: "PE",   room: "COT 509" },
        l4:    { subject: "Maths",room: "VWA 303" },
        lunch: null,
        l5:    { subject: "Sci",  room: "KTU 308" },
        l6:    { subject: "PE",   room: "COT 505" },
        tutor: null
      },
      "Friday": {
        reg:   { subject: "Registration", room: null },
        l1:    { subject: "Computing",          room: "APR 904" },
        l2:    { subject: "Citizen",            room: "EDO 406" },
        break: null,
        l3:    { subject: "Maths",              room: "VWA 303" },
        l4:    { subject: "Eng",                room: "JGR 304" },
        lunch: null,
        l5:    { subject: "Leisure Curriculum", room: null },
        l6:    null,
        tutor: null
      }
    }
  };

  const STORAGE_KEY = "arlo_timetable_state_v3";
  const days = Object.keys(timetable.days);

  function slotKeyFor(dayName, periodKey) {
    return dayName + "_" + periodKey;
  }

  function loadState() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return { subjectMeta: {}, slotState: {} };
      const parsed = JSON.parse(raw);
      return {
        subjectMeta: parsed.subjectMeta || {},
        slotState: parsed.slotState || {}
      };
    } catch (e) {
      return { subjectMeta: {}, slotState: {} };
    }
  }

  function saveState() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  }

  let state = loadState();

  function buildCatchUpIndex() {
    const index = {};
    for (const originKey in state.slotState) {
      const entry = state.slotState[originKey];
      if (!entry || !Array.isArray(entry.catchUpSlots)) continue;
      entry.catchUpSlots.forEach(slotKey => {
        if (!index[slotKey]) index[slotKey] = [];
        index[slotKey].push(originKey);
      });
    }
    return index;
  }

  function describeSlotKey(slotKey) {
    const parts = slotKey.split("_");
    const dayName = parts[0];
    const periodKey = parts[1];
    const period = timetable.periods.find(p => p.key === periodKey);
    const dayData = timetable.days[dayName];
    const slot = dayData ? dayData[periodKey] : null;
    const base = dayName + " · " + (period ? period.name : periodKey);
    if (slot && slot.subject) {
      return slot.subject + " (" + base + ")";
    }
    return base;
  }

  // DOM refs (these EXIST in the markup above)
  const jsStatusEl = document.getElementById("jsStatus");
  const gridBody = document.getElementById("gridBody");
  const overlayEl = document.getElementById("lessonOverlay");
  const popupTitleEl = document.getElementById("popupTitle");
  const popupSubjectEl = document.getElementById("popupSubject");
  const popupWhenEl = document.getElementById("popupWhen");
  const popupRoomEl = document.getElementById("popupRoom");
  const popupFavouriteSubjectEl = document.getElementById("popupFavouriteSubject");
  const popupNeedsCatchupEl = document.getElementById("popupNeedsCatchup");
  const popupNotesEl = document.getElementById("popupNotes");
  const favRow = document.getElementById("popupFavRow");
  const needsRow = document.getElementById("popupNeedsRow");
  const catchupSection = document.getElementById("popupCatchupSection");
  const scheduledForSection = document.getElementById("popupScheduledForSection");
  const scheduledForListEl = document.getElementById("scheduledForList");
  const catchupDaySelect = document.getElementById("catchupDaySelect");
  const catchupPeriodSelect = document.getElementById("catchupPeriodSelect");
  const catchupListEl = document.getElementById("catchupList");
  const catchupAddBtn = document.getElementById("catchupAddBtn");
  const popupSaveBtn = document.getElementById("popupSave");
  const popupCancelBtn = document.getElementById("popupCancel");
  const popupCloseBtn = document.getElementById("popupClose");

  jsStatusEl.textContent = "JS ready";
  jsStatusEl.classList.add("ready");

  // populate selects once
  days.forEach(day => {
    const opt = document.createElement("option");
    opt.value = day;
    opt.textContent = day;
    catchupDaySelect.appendChild(opt);
  });
  timetable.periods.forEach(period => {
    const opt = document.createElement("option");
    opt.value = period.key;
    opt.textContent = period.name + " (" + period.start + "–" + period.end + ")";
    catchupPeriodSelect.appendChild(opt);
  });

  let currentSlotKey = null;
  let currentIsLesson = false;
  let currentSubject = null;
  let currentCatchUpSlots = [];

  function renderCatchupList() {
    catchupListEl.innerHTML = "";
    if (!currentIsLesson) return;

    if (!currentCatchUpSlots || currentCatchUpSlots.length === 0) {
      const empty = document.createElement("div");
      empty.className = "catchup-empty";
      empty.textContent = "No catch-up times set yet.";
      catchupListEl.appendChild(empty);
      return;
    }

    currentCatchUpSlots.forEach(function (slotKey) {
      const item = document.createElement("div");
      item.className = "catchup-item";

      const label = document.createElement("span");
      label.textContent = describeSlotKey(slotKey);

      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "catchup-remove-btn";
      btn.textContent = "Remove";
      btn.addEventListener("click", function () {
        currentCatchUpSlots = currentCatchUpSlots.filter(k => k !== slotKey);
        renderCatchupList();
      });

      item.appendChild(label);
      item.appendChild(btn);
      catchupListEl.appendChild(item);
    });
  }

  catchupAddBtn.addEventListener("click", function () {
    if (!currentIsLesson) return;
    const day = catchupDaySelect.value;
    const periodKey = catchupPeriodSelect.value;
    const key = slotKeyFor(day, periodKey);
    if (!currentCatchUpSlots.includes(key)) {
      currentCatchUpSlots.push(key);
      renderCatchupList();
    }
  });

  function renderScheduledForList(originKeys) {
    scheduledForListEl.innerHTML = "";
    if (!originKeys || originKeys.length === 0) {
      scheduledForSection.style.display = "none";
      return;
    }
    scheduledForSection.style.display = "block";
    originKeys.forEach(function (originKey) {
      const item = document.createElement("div");
      item.className = "catchup-item";
      const label = document.createElement("span");
      label.textContent = describeSlotKey(originKey);
      item.appendChild(label);
      scheduledForListEl.appendChild(item);
    });
  }

  function openSlotPopup(day, periodKey) {
    const period = timetable.periods.find(p => p.key === periodKey);
    const dayData = timetable.days[day];
    const slot = dayData[periodKey];
    const key = slotKeyFor(day, periodKey);
    const slotState = state.slotState[key] || {};
    const catchUpIndex = buildCatchUpIndex();
    const scheduledForHere = catchUpIndex[key] || [];

    currentSlotKey = key;
    currentSubject = slot && slot.subject ? slot.subject : null;
    currentIsLesson = !!slot && !period.special && !!slot.subject;

    const whenText = day + " · " + period.name + " · " + period.start + " – " + period.end;

    if (currentIsLesson) {
      popupTitleEl.textContent = slot.subject;
      popupSubjectEl.textContent = "Subject: " + slot.subject;
      popupRoomEl.textContent = slot.room ? ("Room: " + slot.room) : "Room: (not specified)";
    } else if (slot && slot.subject) {
      popupTitleEl.textContent = slot.subject;
      popupSubjectEl.textContent = "Time slot: " + slot.subject;
      popupRoomEl.textContent = "Room: (not applicable)";
    } else if (period.special) {
      popupTitleEl.textContent = period.name;
      popupSubjectEl.textContent = "Time slot: " + period.name;
      popupRoomEl.textContent = "Room: (not applicable)";
    } else {
      popupTitleEl.textContent = "Free / other time";
      popupSubjectEl.textContent = "Time slot with no set lesson";
      popupRoomEl.textContent = "";
    }

    popupWhenEl.textContent = whenText;
    popupNotesEl.value = slotState.notes || "";

    if (currentIsLesson && currentSubject) {
      const subjectMeta = state.subjectMeta[currentSubject] || {};
      popupFavouriteSubjectEl.checked = !!subjectMeta.favourite;
      popupNeedsCatchupEl.checked = !!slotState.needsCatchUp;
      currentCatchUpSlots = Array.isArray(slotState.catchUpSlots)
        ? slotState.catchUpSlots.slice()
        : [];
      favRow.style.display = "flex";
      needsRow.style.display = "flex";
      catchupSection.style.display = "block";
    } else {
      popupFavouriteSubjectEl.checked = false;
      popupNeedsCatchupEl.checked = false;
      currentCatchUpSlots = [];
      favRow.style.display = "none";
      needsRow.style.display = "none";
      catchupSection.style.display = "none";
    }

    renderCatchupList();
    renderScheduledForList(scheduledForHere);

    overlayEl.classList.add("visible");
  }

  function closeLessonPopup() {
    overlayEl.classList.remove("visible");
    currentSlotKey = null;
    currentSubject = null;
    currentCatchUpSlots = [];
  }

  popupSaveBtn.addEventListener("click", function () {
    if (!currentSlotKey) return;

    if (!state.slotState[currentSlotKey]) state.slotState[currentSlotKey] = {};
    const entry = state.slotState[currentSlotKey];
    entry.notes = popupNotesEl.value;

    if (currentIsLesson && currentSubject) {
      if (!state.subjectMeta[currentSubject]) state.subjectMeta[currentSubject] = {};
      state.subjectMeta[currentSubject].favourite = popupFavouriteSubjectEl.checked;
      entry.needsCatchUp = popupNeedsCatchupEl.checked;
      entry.catchUpSlots = currentCatchUpSlots.slice();
    }

    saveState();
    renderGrid();
    closeLessonPopup();
  });

  popupCancelBtn.addEventListener("click", closeLessonPopup);
  popupCloseBtn.addEventListener("click", closeLessonPopup);
  overlayEl.addEventListener("click", function (e) {
    if (e.target === overlayEl || e.target.classList.contains("overlay-backdrop")) {
      closeLessonPopup();
    }
  });

  function renderGrid() {
    gridBody.innerHTML = "";
    const catchUpIndex = buildCatchUpIndex();

    timetable.periods.forEach(function (period) {
      const tr = document.createElement("tr");
      if (period.special) tr.classList.add("special-row");

      const periodCell = document.createElement("td");
      periodCell.className = "period-col";
      periodCell.innerHTML =
        '<div class="period-name">' + period.name + '</div>' +
        '<div class="period-time">' + period.start + ' – ' + period.end + '</div>';
      tr.appendChild(periodCell);

      days.forEach(function (dayName) {
        const dayData = timetable.days[dayName];
        const slot = dayData[period.key];
        const key = slotKeyFor(dayName, period.key);
        const slotState = state.slotState[key] || {};
        const scheduledFor = catchUpIndex[key] || [];
        const hasNotes = !!(slotState.notes && slotState.notes.trim().length > 0);

        const td = document.createElement("td");
        td.dataset.day = dayName;
        td.dataset.period = period.key;
        td.addEventListener("click", function () {
          openSlotPopup(dayName, period.key);
        });

        if (!slot && !period.special) {
          td.className = "cell-empty";
          td.innerHTML = "<span>–</span>";
        } else if (period.special) {
          td.className = "cell-special";
          td.textContent = period.name;
        } else {
          td.className = "cell-lesson";
          const subject = slot.subject;
          const room = slot.room || "";
          const subjectMeta = state.subjectMeta[subject] || {};
          const isFavSubject = !!subjectMeta.favourite;
          const needsCatchUp = !!slotState.needsCatchUp;

          td.innerHTML =
            '<div class="subject-row">' +
              '<span class="subject-name">' + subject + '</span>' +
              (room ? '<span class="room-tag">' + room + '</span>' : '') +
            '</div>' +
            '<div class="cell-flags">' +
              (isFavSubject ? '<span class="flag fav-flag">★ Favourite</span>' : '') +
              (needsCatchUp ? '<span class="flag catchup-flag">Catch up</span>' : '') +
            '</div>';
        }

        if (hasNotes) {
          const notesHint = document.createElement("div");
          notesHint.className = "notes-hint";
          notesHint.textContent = "Notes saved";
          td.appendChild(notesHint);
        }

        if (scheduledFor.length > 0) {
          const hint = document.createElement("div");
          hint.className = "catchup-target-hint";
          hint.textContent = scheduledFor.length === 1
            ? "Catch-up scheduled here"
            : scheduledFor.length + " catch-ups scheduled here";
          td.appendChild(hint);
        }

        tr.appendChild(td);
      });

      gridBody.appendChild(tr);
    });
  }

  // initial render
  renderGrid();
</script>
</body>
</html>
