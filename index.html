<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Arlo Timetable</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: #f4f4f7;
      color: #222;
    }

    body {
      margin: 0;
      padding: 16px;
      display: flex;
      justify-content: center;
    }

    .app {
      background: #fff;
      border: 2px solid #333;
      border-radius: 12px;
      padding: 16px;
      max-width: 1100px;
      width: 100%;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
    }

    .app-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .week-controls {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .week-label {
      font-weight: 600;
      font-size: 1.1rem;
    }

    button {
      cursor: pointer;
      border-radius: 999px;
      border: 1px solid #333;
      padding: 6px 12px;
      background: #fafafa;
      font-size: 0.9rem;
    }

    button:hover {
      background: #eee;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
    }

    th,
    td {
      border: 1px solid #999;
      padding: 4px;
      text-align: center;
      vertical-align: middle;
      font-size: 0.8rem;
      word-wrap: break-word;
    }

    th {
      background: #f0f0f0;
      font-weight: 600;
    }

    .day-header {
      width: 80px;
      background: #f7f7fa;
      font-weight: 600;
    }

    .col-reg {
      width: 45px;
      font-size: 0.7rem;
    }

    .col-tutor {
      width: 110px;
    }

    .lesson-cell {
      position: relative;
      cursor: pointer;
      background: #fff;
    }

    .lesson-cell.registration {
      background: #f9f9f9;
      cursor: default;
    }

    .lesson-cell:hover:not(.registration) {
      background: #f5fbff;
    }

    .subject-text {
      font-size: 0.8rem;
      line-height: 1.2;
      min-height: 1.2em;
    }

    .subject-text.favourite {
      color: #05823f;
      font-weight: 600;
    }

    .cell-icons {
      margin-top: 2px;
      font-size: 0.9rem;
    }

    .cell-icons span {
      margin: 0 1px;
    }

    .controls-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 4px;
      font-size: 0.75rem;
      align-items: center;
      justify-content: center;
    }

    .controls-row select {
      font-size: 0.75rem;
      padding: 2px 4px;
    }

    .controls-row button {
      font-size: 0.7rem;
      padding: 2px 8px;
    }

    .catchup-tally {
      font-weight: 600;
      font-size: 0.95rem;
      padding: 6px 10px;
      border-radius: 999px;
      background: #fff9e5;
      border: 1px solid #e2b100;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .catchup-tally span.number {
      font-size: 1.1rem;
    }

    @media (max-width: 768px) {
      .app {
        padding: 8px;
      }

      th,
      td {
        font-size: 0.7rem;
      }

      .day-header {
        width: 60px;
      }

      .col-tutor {
        width: 90px;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="app-header">
      <div class="week-controls">
        <button id="prevWeek">&lt; Previous week</button>
        <div class="week-label" id="weekLabel"></div>
        <button id="nextWeek">Next week &gt;</button>
      </div>
      <div class="catchup-tally">
        üìö Outstanding catch up:
        <span class="number" id="catchupCount">0</span>
      </div>
    </div>

    <table id="timetable"></table>
  </div>

  <script type="module">
    // -----------------------------
    // Firebase setup
    // -----------------------------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getFirestore,
      doc,
      getDoc,
      setDoc,
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    // TODO: Replace with your actual Firebase config from the Firebase console
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT_ID.appspot.com",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID",
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // -----------------------------
    // Timetable configuration
    // -----------------------------
    const DAYS = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"];

    // label: header text
    // id: internal key
    // selectable: whether user can interact with this column
    const PERIODS = [
      { id: "reg", label: "Reg", selectable: false, className: "col-reg" },
      { id: "p1", label: "Lesson 1", selectable: true },
      { id: "p2", label: "Lesson 2", selectable: true },
      { id: "p3", label: "Lesson 3", selectable: true },
      { id: "p4", label: "Lesson 4", selectable: true },
      { id: "p5", label: "Lesson 5", selectable: true },
      { id: "tutor", label: "Tutor time", selectable: true, className: "col-tutor" },
    ];

    const CATCHUP_LOCATIONS = [
      "",
      "At school",
      "Library",
      "After school club",
      "At home", // new option
    ];

    // -----------------------------
    // State helpers
    // -----------------------------
    function getMonday(date) {
      const d = new Date(date);
      const day = d.getDay(); // 0 = Sun
      const diff = (day === 0 ? -6 : 1) - day;
      d.setDate(d.getDate() + diff);
      d.setHours(0, 0, 0, 0);
      return d;
    }

    function formatDate(d) {
      return d.toLocaleDateString("en-GB", {
        weekday: "short",
        year: "numeric",
        month: "short",
        day: "numeric",
      });
    }

    function getWeekId(mondayDate) {
      // Use YYYY-MM-DD of Monday as the document id
      const year = mondayDate.getFullYear();
      const month = String(mondayDate.getMonth() + 1).padStart(2, "0");
      const day = String(mondayDate.getDate()).padStart(2, "0");
      return `${year}-${month}-${day}`;
    }

    function buildEmptyWeekState() {
      const state = {};
      for (const day of DAYS) {
        state[day] = {};
        for (const period of PERIODS) {
          state[day][period.id] = {
            subject: "",
            favourite: false,
            catchUpLocation: "",
            missed: false,
          };
        }
      }
      return state;
    }

    let currentMonday = getMonday(new Date());
    let weekState = buildEmptyWeekState();
    let loadingWeek = false;

    const tableEl = document.getElementById("timetable");
    const weekLabelEl = document.getElementById("weekLabel");
    const catchupCountEl = document.getElementById("catchupCount");
    const prevWeekBtn = document.getElementById("prevWeek");
    const nextWeekBtn = document.getElementById("nextWeek");

    // -----------------------------
    // Firebase load/save
    // -----------------------------
    async function loadWeekFromFirebase() {
      loadingWeek = true;
      const weekId = getWeekId(currentMonday);
      weekLabelEl.textContent = `Week of ${formatDate(currentMonday)} (ID: ${weekId})`;

      try {
        const ref = doc(db, "timetables", weekId);
        const snap = await getDoc(ref);

        if (snap.exists()) {
          const data = snap.data();
          // simple defensive merge
          const empty = buildEmptyWeekState();
          for (const day of DAYS) {
            if (!data[day]) {
              data[day] = empty[day];
              continue;
            }
            for (const period of PERIODS) {
              if (!data[day][period.id]) {
                data[day][period.id] = empty[day][period.id];
              }
            }
          }
          weekState = data;
        } else {
          weekState = buildEmptyWeekState();
        }
      } catch (err) {
        console.error("Error loading week:", err);
      } finally {
        loadingWeek = false;
        renderTable();
      }
    }

    async function saveWeekToFirebase() {
      if (loadingWeek) return;
      const weekId = getWeekId(currentMonday);
      try {
        const ref = doc(db, "timetables", weekId);
        await setDoc(ref, weekState, { merge: false });
      } catch (err) {
        console.error("Error saving week:", err);
      }
    }

    // -----------------------------
    // Rendering
    // -----------------------------
    function renderTable() {
      // header
      let html = "<thead><tr>";
      html += '<th class="day-header"></th>'; // top-left blank

      for (const period of PERIODS) {
        const extraClass = period.className ? " " + period.className : "";
        html += `<th class="${extraClass}">${period.label}</th>`;
      }
      html += "</tr></thead><tbody>";

      // body
      for (const day of DAYS) {
        html += `<tr><th class="day-header">${day}</th>`;

        for (const period of PERIODS) {
          const cell = weekState[day][period.id];
          const isReg = period.id === "reg" && !period.selectable;
          const cellClass = [
            "lesson-cell",
            isReg ? "registration" : "",
            period.className || "",
          ]
            .filter(Boolean)
            .join(" ");

          let icons = "";
          if (cell.catchUpLocation) {
            icons += '<span title="Catch up needed">üìö</span>';
          }
          if (cell.missed) {
            icons += '<span title="Missed lesson">‚ùå</span>';
          }

          const favClass = cell.favourite ? "favourite" : "";
          const subjectDisplay = cell.subject || "";

          html += `<td 
              class="${cellClass}" 
              data-day="${day}" 
              data-period="${period.id}"
            >
              <div class="subject-text ${favClass}">${subjectDisplay}</div>
              <div class="cell-icons">${icons}</div>`;

          if (!isReg && period.selectable !== false) {
            html += `
              <div class="controls-row">
                <button data-action="edit-subject">Edit</button>
                <button data-action="toggle-favourite">${
                  cell.favourite ? "Unfavourite" : "Favourite"
                }</button>
              </div>
              <div class="controls-row">
                <label>
                  Catch up:
                  <select data-action="catchup-select">
                    ${CATCHUP_LOCATIONS.map(
                      (loc) =>
                        `<option value="${loc}" ${
                          loc === cell.catchUpLocation ? "selected" : ""
                        }>${loc || "None"}</option>`
                    ).join("")}
                  </select>
                </label>
                <button data-action="toggle-missed">${
                  cell.missed ? "Clear ‚ùå" : "Mark ‚ùå"
                }</button>
              </div>
            `;
          }

          html += "</td>";
        }

        html += "</tr>";
      }

      html += "</tbody>";
      tableEl.innerHTML = html;

      updateCatchupCount();
    }

    function updateCatchupCount() {
      let count = 0;
      for (const day of DAYS) {
        for (const period of PERIODS) {
          const cell = weekState[day][period.id];
          if (cell.catchUpLocation) count += 1;
        }
      }
      catchupCountEl.textContent = count;
    }

    // -----------------------------
    // Event handling
    // -----------------------------
    tableEl.addEventListener("click", (e) => {
      const target = e.target;
      if (!(target instanceof HTMLElement)) return;

      const cellEl = target.closest("td.lesson-cell");
      if (!cellEl) return;

      const day = cellEl.getAttribute("data-day");
      const periodId = cellEl.getAttribute("data-period");
      if (!day || !periodId) return;

      const periodConfig = PERIODS.find((p) => p.id === periodId);
      const isReg =
        periodId === "reg" && periodConfig && periodConfig.selectable === false;
      if (isReg) return;

      const action = target.getAttribute("data-action");
      if (!action) return;

      const cell = weekState[day][periodId];

      if (action === "edit-subject") {
        const newSubject = window.prompt("Subject name:", cell.subject || "");
        if (newSubject !== null) {
          cell.subject = newSubject.trim();
        }
      } else if (action === "toggle-favourite") {
        cell.favourite = !cell.favourite;
      } else if (action === "toggle-missed") {
        cell.missed = !cell.missed;
      }

      saveWeekToFirebase().then(() => renderTable());
    });

    // Change for catch up dropdowns
    tableEl.addEventListener("change", (e) => {
      const target = e.target;
      if (!(target instanceof HTMLSelectElement)) return;
      const action = target.getAttribute("data-action");
      if (action !== "catchup-select") return;

      const cellEl = target.closest("td.lesson-cell");
      if (!cellEl) return;

      const day = cellEl.getAttribute("data-day");
      const periodId = cellEl.getAttribute("data-period");
      if (!day || !periodId) return;

      const cell = weekState[day][periodId];
      cell.catchUpLocation = target.value;

      saveWeekToFirebase().then(() => renderTable());
    });

    // Week navigation
    prevWeekBtn.addEventListener("click", () => {
      currentMonday.setDate(currentMonday.getDate() - 7);
      loadWeekFromFirebase();
    });

    nextWeekBtn.addEventListener("click", () => {
      currentMonday.setDate(currentMonday.getDate() + 7);
      loadWeekFromFirebase();
    });

    // -----------------------------
    // Initial load
    // -----------------------------
    loadWeekFromFirebase();
  </script>
</body>
</html>
